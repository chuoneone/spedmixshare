<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç‰¹æ•™æ•™æè³‡æºå…±äº«å¹³å°</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5BBHYN77N9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-5BBHYN77N9');
    </script>

    <link rel="icon" href="sped2.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-color: #4DB6AC;
        --primary-dark: #00897B;
        --bg-color: #f0f4f7;
        --card-bg: #ffffff;
        --text-color: #37474f;
        --text-light: #78909c;
        --tag-bg: #e0f2f1;
        --tag-text: #00796b;
      }
      body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
      
      header { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 40px 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      header h1 { margin: 0; font-size: 2em; font-weight: 700; letter-spacing: 1px; }
      header p { margin-top: 10px; opacity: 0.9; margin-bottom: 20px; }

      .btn-share {
        display: inline-block;
        background-color: #ffffff;
        color: var(--primary-dark);
        padding: 10px 24px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 700;
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        margin-top: 10px;
      }
      .btn-share:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        background-color: #f1f8e9;
      }

      .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; flex: 1; box-sizing: border-box; width: 100%; }
      
      .control-panel { 
        background: white; padding: 25px; border-radius: 12px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; 
        display: flex; flex-wrap: wrap; gap: 15px; 
        align-items: flex-end; 
        justify-content: center; 
      }
      
      .filter-group { display: flex; flex-direction: column; gap: 5px; }
      .filter-group label { font-size: 0.9em; font-weight: bold; color: var(--primary-dark); }
      
      #searchInput {
        padding: 10px 15px; border-radius: 8px; border: 1px solid #cfd8dc;
        font-size: 14px; width: 200px; max-width: 100%; box-sizing: border-box; transition: border 0.3s;
      }
      #searchInput:focus { border-color: var(--primary-color); outline: none; }

      select { padding: 10px 15px; border-radius: 8px; border: 1px solid #cfd8dc; font-size: 14px; background-color: #fff; min-width: 130px; cursor: pointer; }
      
      .btn-reset {
        background-color: #90a4ae; color: white; border: none; padding: 10px 20px;
        border-radius: 8px; cursor: pointer; font-weight: 500; height: 40px; 
      }
      .btn-reset:hover { background-color: #78909c; }

      .mini-loading-container {
        display: flex;
        align-items: center;
        gap: 8px;
        height: 40px; 
        margin-bottom: 0px; 
        min-width: auto; 
        opacity: 0; 
        transition: opacity 0.3s;
        pointer-events: none;
      }
      
      .spinner-s {
        border: 2px solid #e0f2f1;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        width: 18px;
        height: 18px;
        animation: spin 1s linear infinite;
      }

      #loading-text-s { font-size: 12px; color: var(--text-light); white-space: nowrap; }

      #content { display: grid; gap: 20px; grid-template-columns: 1fr; }
      @media (min-width: 600px) { #content { grid-template-columns: repeat(2, 1fr); } }
      @media (min-width: 1024px) { #content { grid-template-columns: repeat(4, 1fr); } }

      .card { 
        background: var(--card-bg); border-radius: 12px; padding: 20px; 
        box-shadow: 0 3px 6px rgba(0,0,0,0.05); border-left: 6px solid var(--primary-color); 
        transition: transform 0.2s, box-shadow 0.2s; 
        display: flex; flex-direction: column; justify-content: space-between; 
      }
      .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
      
      .card h3 { margin: 0 0 10px 0; font-size: 1.25em; font-weight: 700; color: #263238; }
      .tags { margin-bottom: 10px; }
      .tag { display: inline-block; background: var(--tag-bg); color: var(--tag-text); font-size: 0.8em; padding: 3px 8px; border-radius: 6px; margin-right: 4px; margin-bottom: 6px; font-weight: 500; }
      .tag-type { background-color: #fff3e0; color: #e65100; }
      .meta { font-size: 0.85em; color: var(--text-light); margin-bottom: 15px; font-weight: 500; line-height: 1.6; }
      
      .btn { display: block; background-color: var(--primary-color); color: white; text-align: center; padding: 10px; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background 0.3s; }
      .btn:hover { background-color: var(--primary-dark); }
      .btn.disabled { background-color: #cfd8dc; color: #90a4ae; cursor: not-allowed; pointer-events: none; }

      #first-load-loading { text-align: center; padding: 50px; color: var(--text-light); }

      footer { background-color: #263238; color: #b0bec5; padding: 40px 20px; margin-top: 50px; text-align: center; font-size: 0.9em; }
      .disclaimer-box { max-width: 850px; margin: 0 auto 20px; border: 1px solid #37474f; padding: 20px; border-radius: 12px; background: rgba(255,255,255,0.05); line-height: 1.7; }
      .copyright { color: #80cbc4; font-weight: bold; font-size: 1.1em; display: block; margin-top: 10px; }
      
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      @media (max-width: 600px) {
        .control-panel { flex-direction: column; align-items: stretch; }
        .filter-group, #searchInput, .btn-reset { width: 100%; }
        .mini-loading-container { justify-content: center; margin-top: 5px; }
        header h1 { font-size: 1.5em; }
      }
    </style>
  </head>
  <body>

    <header>
      <h1>ğŸ“ç‰¹æ•™æ•™æè³‡æºå…±äº«å¹³å°</h1>
      <p>åŒ¯é›†å„è·¯ç‰¹æ•™è€å¸«çš„æ™ºæ…§ï¼Œè®“å‚™èª²æ›´è¼•é¬†</p>
      <a href="https://forms.gle/39VbaK5bLfzqMHz69" target="_blank" class="btn-share">ğŸ“¤ æˆ‘è¦åˆ†äº«æ•™æ</a>
    </header>

    <div class="container">
      <div class="control-panel">
        <div class="filter-group">
            <label>ğŸ” é—œéµå­—æœå°‹</label>
            <input type="text" id="searchInput" onkeyup="debounceFilter()" placeholder="æœå°‹æ•™æåç¨±...">
        </div>
        
        <div class="filter-group"><label>ğŸ“ å¹´ç´š</label><select id="gradeSelect" onchange="filterData()"><option value="All">å…¨éƒ¨</option></select></div>
        <div class="filter-group"><label>ğŸ“– ç§‘ç›®</label><select id="subjectSelect" onchange="filterData()"><option value="All">å…¨éƒ¨</option></select></div>
        <div class="filter-group"><label>ğŸ“‚ é¡å‹</label><select id="typeSelect" onchange="filterData()"><option value="All">å…¨éƒ¨</option></select></div>
        <div class="filter-group"><label>ğŸ§  èªçŸ¥ç¨‹åº¦</label><select id="charSelect" onchange="filterData()"><option value="All">å…¨éƒ¨</option></select></div>
        
        <button class="btn-reset" onclick="resetFilters()">æ¸…é™¤ç¯©é¸</button>

        <div id="mini-loading" class="mini-loading-container">
          <div class="spinner-s"></div>
          <span id="loading-text-s">åŒæ­¥ä¸­...</span>
        </div>
      </div>

      <div id="first-load-loading" style="display:none;">
          <div class="spinner-s" style="width:40px; height:40px; margin:0 auto 15px; border-width:4px;"></div>
          <div>æ­£åœ¨é€£ç·šè‡³é›²ç«¯è¼‰å…¥æ•™æ...</div>
      </div>
      
      <div id="content"></div>
    </div>

    <footer>
      <div class="disclaimer-box">
        <p><strong>âš ï¸ å…è²¬è²æ˜ (Disclaimer)</strong></p>
        <p>æœ¬å¹³å°ä¹‹æ•™æå…§å®¹å‡ç”±å„ç‰¹æ•™è€å¸«åˆ†äº«ï¼Œæœ¬äººåƒ…è² è²¬å½™æ•´èˆ‡æ¶è¨­ã€‚æ•™æç‰ˆæ¬Šæ­¸åŸä½œè€…æ‰€æœ‰ï¼Œé€£çµæœ‰æ•ˆæ€§è«‹è‡ªè¡Œæ–Ÿé…Œã€‚</p>
      </div>
      <span class="copyright">Designed by ç±³å…‹å¸«</span>
    </footer>

    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbx_j6IJv8JZcycXQ8U8HTHCbsP7s6VixUG7TsUfgHd8Y-5pyHf4COdfzTsnvDHPoS1M2A/exec";
      const CACHE_KEY = "sped_data_v1";
      const CACHE_TIME_KEY = "sped_timestamp";
      const CACHE_DURATION = 10 * 60 * 1000; 

      const COL_CREATOR_IDX = 1;
      const COL_NAME_IDX = 2;
      const COL_SUBJECT_IDX = 3;
      const COL_GRADE_IDX = 4;
      const COL_LINK_IDX = 5;
      const COL_TYPE_IDX = 10;
      const COL_CHAR_IDX = 13;

      const GRADE_ORDER = ["å­¸å‰", "å°ä¸€", "å°äºŒ", "å°ä¸‰", "å°å››", "å°äº”", "å°å…­", "åœ‹ä¸€", "åœ‹äºŒ", "åœ‹ä¸‰", "é«˜ä¸€", "é«˜äºŒ", "é«˜ä¸‰", "ä¸é™å®š"];
      
      // ğŸ› ï¸ å®šç¾©èªçŸ¥ç¨‹åº¦çš„æ’åºé †åº
      const COGNITIVE_ORDER = ["èªçŸ¥åŠŸèƒ½ç„¡ç¼ºæ", "èªçŸ¥åŠŸèƒ½è¼•å¾®ç¼ºæ", "èªçŸ¥åŠŸèƒ½ä¸­åº¦ç¼ºæ", "èªçŸ¥åŠŸèƒ½åš´é‡ç¼ºæ", "ä¸åˆ†ç¨‹åº¦ / é€šç”¨å‹"];

      let allData = [];
      let searchTimer;

      window.onload = async function() {
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
        const now = new Date().getTime();
        const miniLoading = document.getElementById('mini-loading');

        if (cachedData && cachedTime && (now - cachedTime < CACHE_DURATION)) {
            allData = JSON.parse(cachedData);
            processAndRender(allData, true); 
            miniLoading.style.opacity = "1";
        } else {
            document.getElementById('first-load-loading').style.display = 'block';
        }

        try {
          const response = await fetch(API_URL);
          const data = await response.json();
          data.shift(); 
          
          const freshData = data.map(row => ({
            creator: row[COL_CREATOR_IDX],
            name: row[COL_NAME_IDX],
            subject: row[COL_SUBJECT_IDX],
            grade: row[COL_GRADE_IDX],
            link: row[COL_LINK_IDX],
            type: row[COL_TYPE_IDX],
            char: row[COL_CHAR_IDX]
          }));

          localStorage.setItem(CACHE_KEY, JSON.stringify(freshData));
          localStorage.setItem(CACHE_TIME_KEY, now.toString());

          allData = freshData;
          processAndRender(allData, false);
        } catch (e) {
          miniLoading.style.opacity = "0";
          document.getElementById('first-load-loading').style.display = 'none';
          console.error("Fetch error:", e);
        }
      };

      function processAndRender(data, isUpdating) {
        document.getElementById('first-load-loading').style.display = 'none';
        
        if (!isUpdating) {
            document.getElementById('mini-loading').style.opacity = "0";
        }
        
        populateDropdown('gradeSelect', 'grade');
        populateDropdown('subjectSelect', 'subject');
        populateDropdown('typeSelect', 'type');
        populateDropdown('charSelect', 'char');
        renderCards(data);
      }

      function populateDropdown(elementId, key) {
        const select = document.getElementById(elementId);
        const currentValue = select.value;
        select.innerHTML = '<option value="All">å…¨éƒ¨</option>'; 
        
        let valuesSet = new Set();
        allData.forEach(item => {
          let rawValue = String(item[key] || "");
          if (rawValue.trim() !== "") {
            let parts = rawValue.split(/[,ï¼Œã€]/); 
            parts.forEach(p => valuesSet.add(p.trim()));
          }
        });

        let uniqueValues = Array.from(valuesSet);
        if (key === 'grade') {
          uniqueValues.sort((a, b) => {
             let idxA = GRADE_ORDER.indexOf(a);
             let idxB = GRADE_ORDER.indexOf(b);
             return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
          });
        } else if (key === 'char') {
          // ğŸ› ï¸ è®“èªçŸ¥ç¨‹åº¦ä¾ç…§æŒ‡å®šé †åºæ’åˆ—
          uniqueValues.sort((a, b) => {
             let idxA = COGNITIVE_ORDER.indexOf(a);
             let idxB = COGNITIVE_ORDER.indexOf(b);
             return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
          });
        } else {
          uniqueValues.sort();
        }

        uniqueValues.forEach(val => {
          let opt = document.createElement("option");
          opt.value = val; opt.text = val; 
          select.appendChild(opt);
        });
        select.value = currentValue;
      }

      function debounceFilter() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => { filterData(); }, 300);
      }

      function filterData() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        const grade = document.getElementById('gradeSelect').value;
        const subject = document.getElementById('subjectSelect').value;
        const type = document.getElementById('typeSelect').value;
        const char = document.getElementById('charSelect').value;

        const filtered = allData.filter(item => {
          const matchKeyword = String(item.name || "").toLowerCase().includes(keyword);
          const matchGrade = (grade === 'All') || String(item.grade || "").includes(grade);
          const matchSubject = (subject === 'All') || String(item.subject || "").includes(subject);
          const matchType = (type === 'All') || String(item.type || "").includes(type);
          const matchChar = (char === 'All') || String(item.char || "").includes(char);
          return matchKeyword && matchGrade && matchSubject && matchType && matchChar;
        });

        renderCards(filtered);
      }

      function resetFilters() {
        document.getElementById('searchInput').value = "";
        document.getElementById('gradeSelect').value = "All";
        document.getElementById('subjectSelect').value = "All";
        document.getElementById('typeSelect').value = "All";
        document.getElementById('charSelect').value = "All";
        filterData(); 
      }

      function renderCards(data) {
        const container = document.getElementById('content');
        if(data.length === 0) { 
            container.innerHTML = "<div style='grid-column:1/-1; text-align:center; color:#888; padding: 40px;'>ğŸ” æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ•™æã€‚</div>"; 
            return; 
        }

        container.innerHTML = data.map(item => {
          let link = String(item.link || "").trim();
          let btnHtml = (link.startsWith("http")) 
            ? `<a href="${link}" target="_blank" class="btn">å‰å¾€æ•™æ</a>` 
            : `<div class="btn disabled">ç„¡é€£çµ</div>`;

          return `
            <div class="card">
              <div>
                <div class="tags">
                  <span class="tag">${item.subject || "æœªåˆ†é¡"}</span>
                  <span class="tag">${item.grade || "æœªåˆ†é¡"}</span>
                  ${item.type ? `<span class="tag tag-type">${item.type}</span>` : ''}
                </div>
                <h3>${item.name || "æœªå‘½åæ•™æ"}</h3>
                <div class="meta">
                    ğŸ‘¤ åˆ†äº«è€…ï¼š${item.creator || "åŒ¿å"}<br>
                    ğŸ“Š ç¨‹åº¦ï¼š${item.char || "ä¸é™"}
                </div>
              </div>
              ${btnHtml}
            </div>`;
        }).join('');
      }
    </script>
  </body>
</html>